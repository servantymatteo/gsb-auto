---
# PLAYBOOK ANSIBLE - Installation d'Apache
# Un playbook = une liste de "plays" (t√¢ches √† ex√©cuter)

- name: Installer et configurer Apache sur le container
  # "name" = description de ce que fait ce play

  hosts: all
  # "hosts: all" = ex√©cute sur tous les h√¥tes dans l'inventaire
  # Terraform passera l'IP du container cr√©√© comme inventaire

  become: yes
  # "become: yes" = utilise sudo (ex√©cute en tant que root)
  # N√©cessaire pour installer des paquets

  tasks:
    # "tasks" = liste des t√¢ches √† ex√©cuter dans l'ordre

    - name: S'assurer que SSH est install√© et actif
      # Premi√®re t√¢che : v√©rifier que SSH fonctionne
      apt:
        # Module "apt" = g√®re les paquets Debian/Ubuntu
        name: openssh-server
        # Nom du paquet √† installer
        state: present
        # "present" = s'assurer que le paquet est install√©
        # Si d√©j√† install√©, ne fait rien

    - name: Mettre √† jour le cache apt
      # √âquivalent de : apt-get update
      apt:
        update_cache: yes
        # T√©l√©charge la liste des paquets disponibles
        cache_valid_time: 3600
        # Cache valide pendant 3600 secondes (1h)
        # Si mis √† jour il y a moins d'1h, ne refait pas l'update

    - name: Installer Apache2
      # Installation du serveur web Apache
      apt:
        name: apache2
        # Nom du paquet Apache
        state: present
        # S'assurer qu'il est install√©

    - name: D√©marrer et activer Apache
      # D√©marre Apache maintenant ET au d√©marrage du syst√®me
      systemd:
        # Module "systemd" = g√®re les services systemd
        name: apache2
        # Nom du service
        state: started
        # "started" = d√©marre le service s'il n'est pas d√©marr√©
        enabled: yes
        # "enabled: yes" = d√©marre automatiquement au boot

    - name: Cr√©er une page d'accueil personnalis√©e
      # Remplace la page par d√©faut d'Apache
      copy:
        # Module "copy" = copie du contenu vers un fichier
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Container {{ ansible_hostname }}</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      margin: 50px;
                      background: #f0f0f0;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 { color: #0066cc; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Bienvenue sur le serveur Apache</h1>
                  <p><strong>Hostname:</strong> {{ ansible_hostname }}</p>
                  <p><strong>IP:</strong> {{ ansible_default_ipv4.address }}</p>
                  <p><strong>OS:</strong> {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
                  <hr>
                  <p>‚úÖ D√©ploy√© automatiquement avec <strong>Terraform</strong> + <strong>Ansible</strong></p>
              </div>
          </body>
          </html>
        # Le contenu HTML ci-dessus sera √©crit dans le fichier
        # {{ ansible_hostname }}, etc. = variables Ansible (facts)
        # Ansible collecte automatiquement ces infos sur l'h√¥te
        dest: /var/www/html/index.html
        # Chemin de destination du fichier
        # C'est la page par d√©faut d'Apache

    - name: Ouvrir le port 80 dans le firewall (si UFW actif)
      # Optionnel : ouvre le port HTTP si un firewall est actif
      ufw:
        rule: allow
        port: '80'
        proto: tcp
      ignore_errors: yes
      # "ignore_errors: yes" = continue m√™me si UFW n'est pas install√©

    - name: V√©rifier le statut d'Apache
      # V√©rifie qu'Apache fonctionne correctement
      systemd:
        name: apache2
        state: started
      register: apache_status
      # "register" = sauvegarde le r√©sultat dans une variable

    - name: Afficher le statut d'Apache
      # Affiche un message dans la console
      debug:
        # Module "debug" = affiche des informations
        msg: "‚úÖ Apache est {{ 'actif' if apache_status.status.ActiveState == 'active' else 'inactif' }}"
        # Utilise la variable "apache_status" de la t√¢che pr√©c√©dente

    - name: Afficher l'URL d'acc√®s
      # Informe l'utilisateur comment acc√©der au serveur
      debug:
        msg: "üåê Acc√©dez √† votre serveur : http://{{ ansible_default_ipv4.address }}"
        # ansible_default_ipv4.address = IP du container
