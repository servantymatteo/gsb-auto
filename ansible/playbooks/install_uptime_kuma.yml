---
# PLAYBOOK ANSIBLE - Installation d'Uptime Kuma
- name: Installer et configurer Uptime Kuma sur le container
  hosts: all
  become: yes

  vars:
    uptime_kuma_version: "1.23.13"
    uptime_kuma_port: 3001
    uptime_kuma_user: "uptime-kuma"
    uptime_kuma_dir: "/opt/uptime-kuma"

  tasks:
    - name: Mettre Ã  jour le cache apt
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Installer les dÃ©pendances (Node.js, npm, git)
      apt:
        name:
          - curl
          - git
          - sudo
        state: present

    - name: TÃ©lÃ©charger et installer Node.js 20.x
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Installer Node.js et npm
      apt:
        name:
          - nodejs
        state: present
        update_cache: yes

    - name: CrÃ©er l'utilisateur uptime-kuma
      user:
        name: "{{ uptime_kuma_user }}"
        shell: /bin/bash
        home: "{{ uptime_kuma_dir }}"
        create_home: no
        system: yes

    - name: Supprimer le rÃ©pertoire Uptime Kuma s'il existe
      file:
        path: "{{ uptime_kuma_dir }}"
        state: absent

    - name: Cloner Uptime Kuma depuis GitHub
      git:
        repo: https://github.com/louislam/uptime-kuma.git
        dest: "{{ uptime_kuma_dir }}"
        version: "{{ uptime_kuma_version }}"

    - name: DÃ©finir les permissions sur le dossier Uptime Kuma
      file:
        path: "{{ uptime_kuma_dir }}"
        owner: "{{ uptime_kuma_user }}"
        group: "{{ uptime_kuma_user }}"
        recurse: yes

    - name: Installer les dÃ©pendances npm
      npm:
        path: "{{ uptime_kuma_dir }}"
        state: present
      become_user: "{{ uptime_kuma_user }}"

    - name: Build Uptime Kuma
      shell: npm run setup
      args:
        chdir: "{{ uptime_kuma_dir }}"
      become_user: "{{ uptime_kuma_user }}"

    - name: CrÃ©er le fichier de service systemd
      copy:
        content: |
          [Unit]
          Description=Uptime Kuma
          After=network.target

          [Service]
          Type=simple
          User={{ uptime_kuma_user }}
          WorkingDirectory={{ uptime_kuma_dir }}
          ExecStart=/usr/bin/node server/server.js
          Restart=on-failure
          RestartSec=5s

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/uptime-kuma.service
        mode: '0644'

    - name: Recharger systemd
      systemd:
        daemon_reload: yes

    - name: DÃ©marrer et activer Uptime Kuma
      systemd:
        name: uptime-kuma
        state: started
        enabled: yes

    - name: Attendre que Uptime Kuma soit prÃªt
      wait_for:
        port: "{{ uptime_kuma_port }}"
        delay: 5
        timeout: 60

    - name: CrÃ©er un script Node.js de configuration automatique
      copy:
        content: |
          const io = require('socket.io-client');
          const { exec } = require('child_process');

          async function configure() {
            // Attendre que le service soit prÃªt ET que les autres services soient dÃ©ployÃ©s
            console.log('Attente du dÃ©marrage complet (60 secondes)...');
            await new Promise(resolve => setTimeout(resolve, 60000));

            console.log('Configuration automatique d\'Uptime Kuma...');

            // Scanner le rÃ©seau pour trouver les services
            const subnet = await new Promise((resolve) => {
              exec("ip route | grep -v default | grep eth0 | awk '{print $1}'", (error, stdout) => {
                resolve(stdout.trim());
              });
            });

            console.log(`Scan du rÃ©seau ${subnet}...`);

            // Scanner les ports 80 et 3000
            const services = [];

            // Scanner port 80 (Apache/GLPI)
            const port80 = await new Promise((resolve) => {
              exec(`nmap -p 80 -oG - ${subnet} 2>/dev/null | grep "80/open" | awk '{print $2}'`,
                (error, stdout) => {
                  const ips = stdout.trim().split('\n').filter(ip => ip && ip !== '{{ ansible_default_ipv4.address }}');
                  resolve(ips.map(ip => ({ ip, port: 80 })));
                }
              );
            });

            // Scanner port 3000 (AdGuard)
            const port3000 = await new Promise((resolve) => {
              exec(`nmap -p 3000 -oG - ${subnet} 2>/dev/null | grep "3000/open" | awk '{print $2}'`,
                (error, stdout) => {
                  const ips = stdout.trim().split('\n').filter(ip => ip && ip !== '{{ ansible_default_ipv4.address }}');
                  resolve(ips.map(ip => ({ ip, port: 3000 })));
                }
              );
            });

            services.push(...port80, ...port3000);

            if (services.length === 0) {
              console.log('Aucun service dÃ©tectÃ© sur le rÃ©seau');
              return;
            }

            console.log(`Services trouvÃ©s: ${services.map(s => `${s.ip}:${s.port}`).join(', ')}`);

            // Se connecter Ã  Uptime Kuma
            const socket = io('http://localhost:{{ uptime_kuma_port }}', {
              transports: ['websocket', 'polling']
            });

            socket.on('connect', async () => {
              console.log('ConnectÃ© Ã  Uptime Kuma');

              // CrÃ©er le compte admin
              socket.emit('setup', 'admin', 'admin123', (res) => {
                if (res.ok) {
                  console.log('Compte admin crÃ©Ã© avec succÃ¨s');

                  // Se connecter
                  socket.emit('login', { username: 'admin', password: 'admin123', token: '' }, async (loginRes) => {
                    if (loginRes.ok) {
                      console.log('Connexion rÃ©ussie');

                      // Ajouter les monitors
                      let monitorId = 1;
                      for (const service of services) {
                        let monitor;

                        if (service.port === 3000) {
                          // AdGuard Home
                          monitor = {
                            type: 'http',
                            name: `AdGuard Home (${service.ip})`,
                            url: `http://${service.ip}:3000`,
                            interval: 60,
                            retryInterval: 60,
                            maxretries: 3,
                            active: true
                          };
                        } else if (service.port === 80) {
                          // Tester si GLPI
                          const isGlpi = await new Promise((resolve) => {
                            exec(`curl -s -o /dev/null -w "%{http_code}" http://${service.ip}/glpi`,
                              (error, stdout) => {
                                const code = stdout.trim();
                                resolve(code === '200' || code === '301' || code === '302');
                              }
                            );
                          });

                          monitor = {
                            type: 'http',
                            name: isGlpi ? `GLPI (${service.ip})` : `Apache (${service.ip})`,
                            url: isGlpi ? `http://${service.ip}/glpi` : `http://${service.ip}`,
                            interval: 60,
                            retryInterval: 60,
                            maxretries: 3,
                            active: true
                          };
                        }

                        if (monitor) {
                          socket.emit('add', monitor, (monitorRes) => {
                            if (monitorRes.ok) {
                              console.log(`âœ“ Monitor ajoutÃ©: ${monitor.name}`);
                            }
                          });

                          await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                      }

                      console.log('Configuration terminÃ©e !');
                      setTimeout(() => process.exit(0), 2000);
                    }
                  });
                } else {
                  console.log('Compte admin dÃ©jÃ  existant, tentative de connexion...');
                  process.exit(0);
                }
              });
            });

            socket.on('connect_error', (error) => {
              console.log('Erreur de connexion:', error.message);
            });
          }

          configure().catch(console.error);
        dest: /opt/uptime-kuma/auto-configure.js
        mode: '0644'

    - name: Installer nmap et curl pour le scan rÃ©seau
      apt:
        name:
          - nmap
          - curl
        state: present

    - name: Installer socket.io-client pour le script de configuration
      npm:
        name: socket.io-client
        path: "{{ uptime_kuma_dir }}"
        state: present
      become_user: "{{ uptime_kuma_user }}"

    - name: CrÃ©er un script de reconfiguration manuelle
      copy:
        content: |
          #!/bin/bash
          echo "ğŸ”„ Reconfiguration des monitors Uptime Kuma..."
          echo ""
          cd /opt/uptime-kuma
          sudo -u uptime-kuma node /opt/uptime-kuma/auto-configure.js
          echo ""
          echo "âœ… TerminÃ© ! Consultez le log : /opt/uptime-kuma/configure.log"
        dest: /usr/local/bin/reconfigure-uptime-kuma
        mode: '0755'

    - name: ExÃ©cuter la configuration automatique en arriÃ¨re-plan
      shell: nohup node /opt/uptime-kuma/auto-configure.js > /opt/uptime-kuma/configure.log 2>&1 &
      args:
        chdir: "{{ uptime_kuma_dir }}"
      become_user: "{{ uptime_kuma_user }}"
      async: 300
      poll: 0

    - name: Ouvrir le port dans le firewall (si UFW actif)
      ufw:
        rule: allow
        port: "{{ uptime_kuma_port }}"
        proto: tcp
      ignore_errors: yes

    - name: CrÃ©er un MOTD personnalisÃ©
      copy:
        content: |
          #!/bin/bash

          # Couleurs
          GREEN='\033[0;32m'
          BLUE='\033[0;34m'
          CYAN='\033[0;36m'
          YELLOW='\033[1;33m'
          BOLD='\033[1m'
          NC='\033[0m'

          # RÃ©cupÃ©rer les informations
          HOSTNAME=$(hostname)
          IP=$(hostname -I | awk '{print $1}')
          UPTIME=$(uptime -p | sed 's/up //')
          OS=$(lsb_release -d | cut -f2)
          KERNEL=$(uname -r)
          CPU=$(nproc)
          MEM_TOTAL=$(free -h | awk '/^Mem:/ {print $2}')
          MEM_USED=$(free -h | awk '/^Mem:/ {print $3}')
          DISK_USED=$(df -h / | awk 'NR==2 {print $5}')

          echo ""
          echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
          echo -e "${BOLD}${GREEN}â•‘        ğŸ“Š UPTIME KUMA - PROXMOX LXC                  â•‘${NC}"
          echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo ""
          echo -e "${CYAN}ğŸ“Š Informations systÃ¨me :${NC}"
          echo -e "${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ–¥ï¸  Hostname    : ${YELLOW}${HOSTNAME}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸŒ IP          : ${YELLOW}${IP}${NC}"
          echo -e "${BOLD}â”‚${NC} â±  Uptime      : ${YELLOW}${UPTIME}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ’» OS          : ${YELLOW}${OS}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ”§ Kernel      : ${YELLOW}${KERNEL}${NC}"
          echo -e "${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
          echo ""
          echo -e "${CYAN}ğŸ’¾ Ressources :${NC}"
          echo -e "${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
          echo -e "${BOLD}â”‚${NC} CPU          : ${YELLOW}${CPU} cores${NC}"
          echo -e "${BOLD}â”‚${NC} RAM          : ${YELLOW}${MEM_USED} / ${MEM_TOTAL}${NC}"
          echo -e "${BOLD}â”‚${NC} Disque       : ${YELLOW}${DISK_USED} utilisÃ©${NC}"
          echo -e "${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
          echo ""
          echo -e "${BLUE}ğŸ“Š Uptime Kuma : ${BOLD}http://${IP}:{{ uptime_kuma_port }}${NC}"
          echo -e "${CYAN}ğŸ‘¤ Admin : ${YELLOW}admin / admin123${NC}"
          echo -e "${CYAN}ğŸ‘ï¸  Monitoring de tous vos services${NC}"
          echo ""
          echo -e "${CYAN}ğŸ”§ Reconfigurer les monitors : ${YELLOW}reconfigure-uptime-kuma${NC}"
          echo ""
        dest: /etc/update-motd.d/99-custom-motd
        mode: '0755'

    - name: Afficher les informations de connexion
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      UPTIME KUMA INSTALLÃ‰ ET CONFIGURÃ‰ ! âœ“     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸŒ URL d'accÃ¨s: http://{{ ansible_default_ipv4.address }}:{{ uptime_kuma_port }}

          ğŸ” Compte administrateur (crÃ©Ã© automatiquement) :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ‘¤ Utilisateur : admin                         â”‚
          â”‚ ğŸ”‘ Mot de passe : admin123                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ“Š Monitoring :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ‘ï¸  Interface : Port {{ uptime_kuma_port }}                      â”‚
          â”‚ ğŸ“ˆ Status     : Actif                          â”‚
          â”‚ ğŸ” Scan rÃ©seau : En cours...                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ“‹ Informations du serveur :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Hostname : {{ ansible_hostname }}              â”‚
          â”‚ IP       : {{ ansible_default_ipv4.address }}  â”‚
          â”‚ Version  : {{ uptime_kuma_version }}           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ’¡ Configuration automatique :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 1. Compte admin crÃ©Ã© automatiquement âœ“        â”‚
          â”‚ 2. Scan rÃ©seau en cours (60s de dÃ©lai)        â”‚
          â”‚ 3. Monitors ajoutÃ©s automatiquement           â”‚
          â”‚ 4. Log : /opt/uptime-kuma/configure.log       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ”§ Si les monitors ne sont pas ajoutÃ©s :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ SSH dans le container et lancez :             â”‚
          â”‚ $ reconfigure-uptime-kuma                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          âš ï¸  IMPORTANT : Changez le mot de passe admin !
          ğŸ“ Commande de reconfiguration disponible
