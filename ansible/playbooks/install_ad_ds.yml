---
# PLAYBOOK ANSIBLE - Installation et configuration Active Directory Domain Services
- name: Installer et configurer Active Directory sur Windows Server
  hosts: all
  gather_facts: yes

  vars:
    domain_name: "gsb.local"
    domain_netbios: "GSB"
    safe_mode_password: "SafeMode123@"
    dns_forwarders:
      - "8.8.8.8"
      - "8.8.4.4"

  tasks:
    - name: Attendre que WinRM soit disponible
      wait_for_connection:
        timeout: 300
        delay: 10

    - name: Installer le rÃ´le AD DS
      win_feature:
        name:
          - AD-Domain-Services
          - RSAT-ADDS
          - DNS
        include_management_tools: yes
        state: present
      register: adds_install

    - name: RedÃ©marrer si nÃ©cessaire aprÃ¨s installation AD DS
      win_reboot:
        msg: "RedÃ©marrage aprÃ¨s installation AD DS"
        pre_reboot_delay: 10
      when: adds_install.reboot_required

    - name: Promouvoir le serveur en contrÃ´leur de domaine
      win_domain:
        dns_domain_name: "{{ domain_name }}"
        domain_netbios_name: "{{ domain_netbios }}"
        safe_mode_password: "{{ safe_mode_password }}"
        create_dns_delegation: no
        database_path: "C:\\Windows\\NTDS"
        sysvol_path: "C:\\Windows\\SYSVOL"
        install_dns: yes
      register: domain_install

    - name: RedÃ©marrer aprÃ¨s promotion DC
      win_reboot:
        msg: "RedÃ©marrage aprÃ¨s promotion en contrÃ´leur de domaine"
        pre_reboot_delay: 10
        post_reboot_delay: 60
      when: domain_install.reboot_required

    - name: Attendre que le domaine soit opÃ©rationnel
      win_wait_for:
        timeout: 300
        delay: 30

    - name: Configurer les redirecteurs DNS
      win_shell: |
        Add-DnsServerForwarder -IPAddress {{ dns_forwarders | join(',') }} -PassThru
      ignore_errors: yes

    - name: CrÃ©er une OU pour les utilisateurs
      win_domain_ou:
        name: Utilisateurs_GSB
        path: "DC=gsb,DC=local"
        state: present
      ignore_errors: yes

    - name: CrÃ©er une OU pour les ordinateurs
      win_domain_ou:
        name: Ordinateurs_GSB
        path: "DC=gsb,DC=local"
        state: present
      ignore_errors: yes

    - name: CrÃ©er une OU pour les serveurs
      win_domain_ou:
        name: Serveurs_GSB
        path: "DC=gsb,DC=local"
        state: present
      ignore_errors: yes

    - name: CrÃ©er un groupe d'administrateurs GSB
      win_domain_group:
        name: Admins_GSB
        scope: global
        category: security
        organizational_unit: "OU=Utilisateurs_GSB,DC=gsb,DC=local"
        state: present
      ignore_errors: yes

    - name: CrÃ©er un utilisateur administrateur de test
      win_domain_user:
        name: admin.gsb
        firstname: Admin
        surname: GSB
        password: "Admin123@"
        state: present
        path: "OU=Utilisateurs_GSB,DC=gsb,DC=local"
        groups:
          - Domain Admins
          - Admins_GSB
        password_never_expires: yes
        user_cannot_change_password: no
      ignore_errors: yes

    - name: CrÃ©er des utilisateurs de test
      win_domain_user:
        name: "{{ item.name }}"
        firstname: "{{ item.firstname }}"
        surname: "{{ item.surname }}"
        password: "User123@"
        state: present
        path: "OU=Utilisateurs_GSB,DC=gsb,DC=local"
        password_never_expires: no
        user_cannot_change_password: no
      loop:
        - { name: "user1.gsb", firstname: "Utilisateur", surname: "Un" }
        - { name: "user2.gsb", firstname: "Utilisateur", surname: "Deux" }
        - { name: "user3.gsb", firstname: "Utilisateur", surname: "Trois" }
      ignore_errors: yes

    - name: Afficher les informations de connexion
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ACTIVE DIRECTORY INSTALLÃ‰ ET CONFIGURÃ‰ ! âœ“  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸŒ Domaine : {{ domain_name }}
          ğŸ·ï¸  NetBIOS : {{ domain_netbios }}

          ğŸ” Compte Administrateur Principal :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ‘¤ Utilisateur : Administrator                 â”‚
          â”‚ ğŸ”‘ Mot de passe : Admin123@                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ” Compte Administrateur de domaine :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ‘¤ Utilisateur : admin.gsb@{{ domain_name }}   â”‚
          â”‚ ğŸ”‘ Mot de passe : Admin123@                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ‘¥ Comptes utilisateurs de test crÃ©Ã©s :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ â€¢ user1.gsb@{{ domain_name }} / User123@       â”‚
          â”‚ â€¢ user2.gsb@{{ domain_name }} / User123@       â”‚
          â”‚ â€¢ user3.gsb@{{ domain_name }} / User123@       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ“ UnitÃ©s d'organisation crÃ©Ã©es :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ â€¢ OU=Utilisateurs_GSB,DC=gsb,DC=local          â”‚
          â”‚ â€¢ OU=Ordinateurs_GSB,DC=gsb,DC=local           â”‚
          â”‚ â€¢ OU=Serveurs_GSB,DC=gsb,DC=local              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸŒ Serveurs DNS configurÃ©s : {{ dns_forwarders | join(', ') }}

          ğŸ“‹ Informations du serveur :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Nom : {{ ansible_hostname }}                   â”‚
          â”‚ IP  : {{ ansible_ip_addresses[0] }}            â”‚
          â”‚ OS  : {{ ansible_os_family }} {{ ansible_distribution_version }} â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ’¡ Joindre un poste au domaine :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 1. Configurer le DNS : {{ ansible_ip_addresses[0] }}              â”‚
          â”‚ 2. Joindre le domaine : {{ domain_name }}      â”‚
          â”‚ 3. Utiliser : admin.gsb@{{ domain_name }}      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          âš ï¸  IMPORTANT :
          â€¢ Changez TOUS les mots de passe par dÃ©faut !
          â€¢ Le mot de passe Safe Mode est : {{ safe_mode_password }}
          â€¢ Sauvegardez les informations de rÃ©cupÃ©ration
