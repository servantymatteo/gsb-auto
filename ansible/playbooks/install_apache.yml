---
# PLAYBOOK ANSIBLE - Installation d'Apache
# Un playbook = une liste de "plays" (tÃ¢ches Ã  exÃ©cuter)

- name: Installer et configurer Apache sur le container
  # "name" = description de ce que fait ce play

  hosts: all
  # "hosts: all" = exÃ©cute sur tous les hÃ´tes dans l'inventaire
  # Terraform passera l'IP du container crÃ©Ã© comme inventaire

  become: yes
  # "become: yes" = utilise sudo (exÃ©cute en tant que root)
  # NÃ©cessaire pour installer des paquets

  tasks:
    # "tasks" = liste des tÃ¢ches Ã  exÃ©cuter dans l'ordre

    - name: S'assurer que SSH est installÃ© et actif
      # PremiÃ¨re tÃ¢che : vÃ©rifier que SSH fonctionne
      apt:
        # Module "apt" = gÃ¨re les paquets Debian/Ubuntu
        name: openssh-server
        # Nom du paquet Ã  installer
        state: present
        # "present" = s'assurer que le paquet est installÃ©
        # Si dÃ©jÃ  installÃ©, ne fait rien

    - name: Mettre Ã  jour le cache apt
      # Ã‰quivalent de : apt-get update
      apt:
        update_cache: yes
        # TÃ©lÃ©charge la liste des paquets disponibles
        cache_valid_time: 3600
        # Cache valide pendant 3600 secondes (1h)
        # Si mis Ã  jour il y a moins d'1h, ne refait pas l'update

    - name: Installer Apache2
      # Installation du serveur web Apache
      apt:
        name: apache2
        # Nom du paquet Apache
        state: present
        # S'assurer qu'il est installÃ©

    - name: DÃ©marrer et activer Apache
      # DÃ©marre Apache maintenant ET au dÃ©marrage du systÃ¨me
      systemd:
        # Module "systemd" = gÃ¨re les services systemd
        name: apache2
        # Nom du service
        state: started
        # "started" = dÃ©marre le service s'il n'est pas dÃ©marrÃ©
        enabled: yes
        # "enabled: yes" = dÃ©marre automatiquement au boot

    - name: CrÃ©er une page d'accueil personnalisÃ©e
      # Remplace la page par dÃ©faut d'Apache
      copy:
        # Module "copy" = copie du contenu vers un fichier
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Container {{ ansible_hostname }}</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      margin: 50px;
                      background: #f0f0f0;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 { color: #0066cc; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸš€ Bienvenue sur le serveur Apache</h1>
                  <p><strong>Hostname:</strong> {{ ansible_hostname }}</p>
                  <p><strong>IP:</strong> {{ ansible_default_ipv4.address }}</p>
                  <p><strong>OS:</strong> {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
                  <hr>
                  <p>âœ… DÃ©ployÃ© automatiquement avec <strong>Terraform</strong> + <strong>Ansible</strong></p>
              </div>
          </body>
          </html>
        # Le contenu HTML ci-dessus sera Ã©crit dans le fichier
        # {{ ansible_hostname }}, etc. = variables Ansible (facts)
        # Ansible collecte automatiquement ces infos sur l'hÃ´te
        dest: /var/www/html/index.html
        # Chemin de destination du fichier
        # C'est la page par dÃ©faut d'Apache

    - name: Ouvrir le port 80 dans le firewall (si UFW actif)
      # Optionnel : ouvre le port HTTP si un firewall est actif
      ufw:
        rule: allow
        port: '80'
        proto: tcp
      ignore_errors: yes
      # "ignore_errors: yes" = continue mÃªme si UFW n'est pas installÃ©

    - name: CrÃ©er un MOTD personnalisÃ©
      copy:
        content: |
          #!/bin/bash

          # Couleurs
          GREEN='\033[0;32m'
          BLUE='\033[0;34m'
          CYAN='\033[0;36m'
          YELLOW='\033[1;33m'
          BOLD='\033[1m'
          NC='\033[0m'

          # RÃ©cupÃ©rer les informations
          HOSTNAME=$(hostname)
          IP=$(hostname -I | awk '{print $1}')
          UPTIME=$(uptime -p | sed 's/up //')
          OS=$(lsb_release -d | cut -f2)
          KERNEL=$(uname -r)
          CPU=$(nproc)
          MEM_TOTAL=$(free -h | awk '/^Mem:/ {print $2}')
          MEM_USED=$(free -h | awk '/^Mem:/ {print $3}')
          DISK_USED=$(df -h / | awk 'NR==2 {print $5}')

          echo ""
          echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
          echo -e "${BOLD}${GREEN}â•‘           ğŸš€ SERVEUR APACHE - PROXMOX LXC            â•‘${NC}"
          echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo ""
          echo -e "${CYAN}ğŸ“Š Informations systÃ¨me :${NC}"
          echo -e "${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ–¥ï¸  Hostname    : ${YELLOW}${HOSTNAME}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸŒ IP          : ${YELLOW}${IP}${NC}"
          echo -e "${BOLD}â”‚${NC} â±  Uptime      : ${YELLOW}${UPTIME}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ’» OS          : ${YELLOW}${OS}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ”§ Kernel      : ${YELLOW}${KERNEL}${NC}"
          echo -e "${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
          echo ""
          echo -e "${CYAN}ğŸ’¾ Ressources :${NC}"
          echo -e "${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
          echo -e "${BOLD}â”‚${NC} CPU          : ${YELLOW}${CPU} cores${NC}"
          echo -e "${BOLD}â”‚${NC} RAM          : ${YELLOW}${MEM_USED} / ${MEM_TOTAL}${NC}"
          echo -e "${BOLD}â”‚${NC} Disque       : ${YELLOW}${DISK_USED} utilisÃ©${NC}"
          echo -e "${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
          echo ""
          echo -e "${BLUE}ğŸŒ AccÃ¨s web : ${BOLD}http://${IP}${NC}"
          echo ""
        dest: /etc/update-motd.d/99-custom-motd
        mode: '0755'

    - name: VÃ©rifier le statut d'Apache
      # VÃ©rifie qu'Apache fonctionne correctement
      systemd:
        name: apache2
        state: started
      register: apache_status
      # "register" = sauvegarde le rÃ©sultat dans une variable

    - name: Afficher les informations de connexion
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         APACHE INSTALLÃ‰ ET CONFIGURÃ‰ ! âœ“       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸŒ URL d'accÃ¨s: http://{{ ansible_default_ipv4.address }}

          ğŸ“‹ Informations du serveur :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Hostname  : {{ ansible_hostname }}
          â”‚ IP        : {{ ansible_default_ipv4.address }}
          â”‚ OS        : {{ ansible_distribution }} {{ ansible_distribution_version }}
          â”‚ Statut    : {{ 'Actif âœ“' if apache_status.status.ActiveState == 'active' else 'Inactif âœ—' }}
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ’¡ Page personnalisÃ©e crÃ©Ã©e automatiquement
