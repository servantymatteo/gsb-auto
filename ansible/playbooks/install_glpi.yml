---
# PLAYBOOK ANSIBLE - Installation de GLPI
- name: Installer et configurer GLPI sur le container
  hosts: all
  become: yes

  vars:
    glpi_version: "10.0.16"
    glpi_download_url: "https://github.com/glpi-project/glpi/releases/download/{{ glpi_version }}/glpi-{{ glpi_version }}.tgz"
    mysql_root_password: "glpi_root_pass"
    glpi_db_name: "glpidb"
    glpi_db_user: "glpi_user"
    glpi_db_password: "glpi_password"

  tasks:
    - name: Mettre Ã  jour le cache apt
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Installer les dÃ©pendances (Apache, PHP, MariaDB)
      apt:
        name:
          - apache2
          - mariadb-server
          - php
          - php-mysql
          - php-mbstring
          - php-curl
          - php-gd
          - php-xml
          - php-intl
          - php-ldap
          - php-zip
          - php-bz2
          - php-cli
          - python3-pymysql
          - sudo
          - wget
          - tar
        state: present

    - name: DÃ©marrer et activer Apache
      systemd:
        name: apache2
        state: started
        enabled: yes

    - name: DÃ©marrer et activer MariaDB
      systemd:
        name: mariadb
        state: started
        enabled: yes

    - name: CrÃ©er la base de donnÃ©es GLPI
      mysql_db:
        name: "{{ glpi_db_name }}"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: CrÃ©er l'utilisateur MySQL pour GLPI
      mysql_user:
        name: "{{ glpi_db_user }}"
        password: "{{ glpi_db_password }}"
        priv: "{{ glpi_db_name }}.*:ALL"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: TÃ©lÃ©charger GLPI
      get_url:
        url: "{{ glpi_download_url }}"
        dest: "/tmp/glpi-{{ glpi_version }}.tgz"

    - name: Extraire GLPI dans /var/www/html
      unarchive:
        src: "/tmp/glpi-{{ glpi_version }}.tgz"
        dest: /var/www/html
        remote_src: yes

    - name: DÃ©finir les permissions sur le dossier GLPI
      file:
        path: /var/www/html/glpi
        owner: www-data
        group: www-data
        recurse: yes

    - name: VÃ©rifier si GLPI est dÃ©jÃ  installÃ©
      stat:
        path: /var/www/html/glpi/config/config_db.php
      register: glpi_installed

    - name: Installer GLPI via la ligne de commande
      command: >
        php bin/console db:install
        --db-host=localhost
        --db-name={{ glpi_db_name }}
        --db-user={{ glpi_db_user }}
        --db-password={{ glpi_db_password }}
        --no-interaction
        --force
      args:
        chdir: /var/www/html/glpi
      become_user: www-data
      when: not glpi_installed.stat.exists

    - name: Supprimer le fichier d'installation
      file:
        path: /var/www/html/glpi/install/install.php
        state: absent

    - name: CrÃ©er une page de redirection vers GLPI
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <meta http-equiv="refresh" content="0; url=/glpi" />
              <title>Redirection vers GLPI</title>
          </head>
          <body>
              <p>Redirection vers <a href="/glpi">GLPI</a>...</p>
          </body>
          </html>
        dest: /var/www/html/index.html

    - name: CrÃ©er un MOTD personnalisÃ©
      copy:
        content: |
          #!/bin/bash

          # Couleurs
          GREEN='\033[0;32m'
          BLUE='\033[0;34m'
          CYAN='\033[0;36m'
          YELLOW='\033[1;33m'
          BOLD='\033[1m'
          NC='\033[0m'

          # RÃ©cupÃ©rer les informations
          HOSTNAME=$(hostname)
          IP=$(hostname -I | awk '{print $1}')
          UPTIME=$(uptime -p | sed 's/up //')
          OS=$(lsb_release -d | cut -f2)
          KERNEL=$(uname -r)
          CPU=$(nproc)
          MEM_TOTAL=$(free -h | awk '/^Mem:/ {print $2}')
          MEM_USED=$(free -h | awk '/^Mem:/ {print $3}')
          DISK_USED=$(df -h / | awk 'NR==2 {print $5}')

          echo ""
          echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
          echo -e "${BOLD}${GREEN}â•‘            ğŸ¯ SERVEUR GLPI - PROXMOX LXC             â•‘${NC}"
          echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo ""
          echo -e "${CYAN}ğŸ“Š Informations systÃ¨me :${NC}"
          echo -e "${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ–¥ï¸  Hostname    : ${YELLOW}${HOSTNAME}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸŒ IP          : ${YELLOW}${IP}${NC}"
          echo -e "${BOLD}â”‚${NC} â±  Uptime      : ${YELLOW}${UPTIME}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ’» OS          : ${YELLOW}${OS}${NC}"
          echo -e "${BOLD}â”‚${NC} ğŸ”§ Kernel      : ${YELLOW}${KERNEL}${NC}"
          echo -e "${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
          echo ""
          echo -e "${CYAN}ğŸ’¾ Ressources :${NC}"
          echo -e "${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
          echo -e "${BOLD}â”‚${NC} CPU          : ${YELLOW}${CPU} cores${NC}"
          echo -e "${BOLD}â”‚${NC} RAM          : ${YELLOW}${MEM_USED} / ${MEM_TOTAL}${NC}"
          echo -e "${BOLD}â”‚${NC} Disque       : ${YELLOW}${DISK_USED} utilisÃ©${NC}"
          echo -e "${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
          echo ""
          echo -e "${BLUE}ğŸŒ AccÃ¨s GLPI : ${BOLD}http://${IP}/glpi${NC}"
          echo -e "${CYAN}ğŸ‘¤ Compte admin : ${YELLOW}glpi / glpi${NC}"
          echo ""
        dest: /etc/update-motd.d/99-custom-motd
        mode: '0755'

    - name: Afficher les informations de connexion
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         GLPI INSTALLÃ‰ ET CONFIGURÃ‰ ! âœ“         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸŒ URL d'accÃ¨s: http://{{ ansible_default_ipv4.address }}/glpi

          ğŸ“ Identifiants par dÃ©faut :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ‘¤ Admin     : glpi / glpi                     â”‚
          â”‚ ğŸ”§ Tech      : tech / tech                     â”‚
          â”‚ ğŸ‘¥ Normal    : normal / normal                 â”‚
          â”‚ ğŸ“® Post-only : post-only / postonly            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ” Base de donnÃ©es MySQL :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Nom         : {{ glpi_db_name }}               â”‚
          â”‚ Utilisateur : {{ glpi_db_user }}               â”‚
          â”‚ Mot de passe: {{ glpi_db_password }}           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          ğŸ“‹ Informations du serveur :
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Hostname : {{ ansible_hostname }}              â”‚
          â”‚ IP       : {{ ansible_default_ipv4.address }}  â”‚
          â”‚ Version  : GLPI {{ glpi_version }}             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          âš ï¸  IMPORTANT : Changez les mots de passe par dÃ©faut !
          ğŸ’¡ La redirection automatique vers GLPI est active
